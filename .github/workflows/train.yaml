# name: ML Training Pipeline

# on:
#   push:
#     branches: ["main"]
#   pull_request:
#     branches: ["main"]

# jobs:
#   train:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.9"

#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt

#       - name: Run training script
#         run: |
#           python train.py | tee output.txt

#       - name: Write Job Summary
#         run: |
#           echo "## Lab 2 â€“ Model Training Summary" >> $GITHUB_STEP_SUMMARY
#           echo "**Name:** Rallapalli V S B Harshith" >> $GITHUB_STEP_SUMMARY
#           echo "**Roll Number:** 2022BCS0042" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "### Evaluation Metrics" >> $GITHUB_STEP_SUMMARY
#           cat output.txt >> $GITHUB_STEP_SUMMARY

#       - name: Upload Model Artifact
#         uses: actions/upload-artifact@v4
#         with:
#           name: trained-model
#           path: outputs/model/

#       - name: Upload Metrics Artifact
#         uses: actions/upload-artifact@v4
#         with:
#           name: evaluation-results
#           path: outputs/results/



# yaml file changed for lab 4
name: ML Train and Deploy Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # -----------------------
  # Job 1: TRAIN (CI)
  # -----------------------
  train:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run training
        run: |
          python train.py
          # must create metrics.json and model file

      - name: Show metrics
        run: cat outputs/results/metrics.json

      # Save metrics for next job
      - name: Extract metrics
        id: metrics
        run: |
          echo "MSE=$(jq -r '."Mean Squared Error"' outputs/results/metrics.json)" >> $GITHUB_OUTPUT
          echo "R2=$(jq -r '."R2 Score"' outputs/results/metrics.json)" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts
          path: |
            outputs/

    outputs:
      mse: ${{ steps.metrics.outputs.MSE }}
      r2:  ${{ steps.metrics.outputs.R2 }}

  # -----------------------
  # Job 2: DEPLOY (CD)
  # -----------------------
  deploy:
    needs: train
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: model-artifacts

      - name: Compare metrics
        id: compare
        run: |
          CUR_MSE=${{ needs.train.outputs.mse }}
          CUR_R2=${{ needs.train.outputs.r2 }}

          BEST_MSE=${{ vars.BEST_MSE }}
          BEST_R2=${{ vars.BEST_R2 }}

          echo "Current MSE: $CUR_MSE | Best MSE: $BEST_MSE"
          echo "Current R2: $CUR_R2 | Best R2: $BEST_R2"

          improve_mse=$(echo "$CUR_MSE < $BEST_MSE" | bc -l)
          improve_r2=$(echo "$CUR_R2 > $BEST_R2" | bc -l)

          if [ "$improve_mse" -eq 1 ] && [ "$improve_r2" -eq 1 ]; then
            echo "improved=true" >> $GITHUB_OUTPUT
          else
            echo "improved=false" >> $GITHUB_OUTPUT
          fi

      - name: Stop if no improvement
        if: steps.compare.outputs.improved == 'false'
        run: |
          echo "${{ github.actor }} ---- Metric did not improve"
          exit 0

      # -------- Docker Build & Push --------

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/ml-model:latest .
          # push docker image
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/ml-model:latest

      # -------- Update GitHub Variables --------

      - name: Update BEST_MSE and BEST_R2
        run: |
          curl -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GH_PAT }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/variables/BEST_MSE \
            -d '{"name":"BEST_MSE","value":"${{ needs.train.outputs.mse }}"}'

          curl -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GH_PAT }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/variables/BEST_R2 \
            -d '{"name":"BEST_R2","value":"${{ needs.train.outputs.r2 }}"}'
