# name: ML Training Pipeline

# on:
#   push:
#     branches: ["main"]
#   pull_request:
#     branches: ["main"]

# jobs:
#   train:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: "3.9"

#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt

#       - name: Run training script
#         run: |
#           python train.py | tee output.txt

#       - name: Write Job Summary
#         run: |
#           echo "## Lab 2 â€“ Model Training Summary" >> $GITHUB_STEP_SUMMARY
#           echo "**Name:** Rallapalli V S B Harshith" >> $GITHUB_STEP_SUMMARY
#           echo "**Roll Number:** 2022BCS0042" >> $GITHUB_STEP_SUMMARY
#           echo "" >> $GITHUB_STEP_SUMMARY
#           echo "### Evaluation Metrics" >> $GITHUB_STEP_SUMMARY
#           cat output.txt >> $GITHUB_STEP_SUMMARY

#       - name: Upload Model Artifact
#         uses: actions/upload-artifact@v4
#         with:
#           name: trained-model
#           path: outputs/model/

#       - name: Upload Metrics Artifact
#         uses: actions/upload-artifact@v4
#         with:
#           name: evaluation-results
#           path: outputs/results/



# for lab4 
name: ML CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

# --------------------------
# Global Environment Variables
# --------------------------
env:
  MODEL_DIR: outputs/model
  METRICS_DIR: outputs/results
  METRICS_FILE: outputs/results/metrics.json
  DOCKER_IMAGE: yourdockerhubusername/wine-quality-api:latest

# ==========================
# Job 1: Train Model (CI)
# ==========================
jobs:
  train:
    name: Train Model
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run training script
        run: |
          python train.py
          # Ensure metrics.json is generated in outputs/results/

      - name: Upload Model Artifact
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: ${{ env.MODEL_DIR }}/  # upload folder, not single file

      - name: Upload Metrics Artifact
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-results
          path: ${{ env.METRICS_DIR }}/  # upload folder

# ==========================
# Job 2: Deploy Model (CD)
# ==========================
  deploy:
    name: Deploy Model
    runs-on: ubuntu-latest
    needs: train          # Runs only if train job succeeds
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Model Artifact
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: ${{ env.MODEL_DIR }}/  # download to folder

      - name: Download Metrics Artifact
        uses: actions/download-artifact@v4
        with:
          name: evaluation-results
          path: ${{ env.METRICS_DIR }}/  # download to folder

      # --------------------------
      # Compare Current Metric vs BEST_F1
      # --------------------------
      - name: Compare Metrics
        id: compare_metrics
        run: |
          METRIC=$(jq '.f1_score' ${{ env.METRICS_FILE }})
          BEST_METRIC=${{ vars.BEST_F1 }}
          echo "Current F1: $METRIC, Best F1: $BEST_METRIC"

          if (( $(echo "$METRIC > $BEST_METRIC" | bc -l) )); then
            echo "Metric improved!"
            echo "METRIC_IMPROVED=true" >> $GITHUB_ENV
            echo "CURRENT_METRIC=$METRIC" >> $GITHUB_ENV
          else
            echo "Roll_no: 2022BCS0042 ---- Metric did not improve"
            echo "METRIC_IMPROVED=false" >> $GITHUB_ENV
          fi

      # --------------------------
      # Build and Push Docker Image if Metric Improved
      # --------------------------
      - name: Build and Push Docker Image
        if: env.METRIC_IMPROVED == 'true'
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ env.DOCKER_IMAGE }}
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # --------------------------
      # Update BEST_F1 GitHub Variable
      # --------------------------
      - name: Update Best F1 GitHub Variable
        if: env.METRIC_IMPROVED == 'true'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GH_PAT }}
          script: |
            await github.actions.updateRepoVariable({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: "BEST_F1",
              value: process.env.CURRENT_METRIC
            })
